<div class="container mx-auto px-4 py-8">
  <div class="mb-6">
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
      <div class="flex items-center">
        <% if request.referer && request.referer != request.original_url %>
          <%= link_to :back, class: "text-2xl text-gray-700 hover:text-gray-900 mr-3" do %>
            <i class="fas fa-arrow-left"></i>
          <% end %>
        <% end %>
        <h1 class="text-2xl font-bold text-gray-800">Calendário de Ponto</h1>
      </div>

      <div>
        <%= button_to quick_register_time_entries_path(return_to: "calendar"), method: :post, class: "bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2.5 rounded-lg shadow-sm flex items-center transition duration-150 ease-in-out" do %>
          <i class="fas fa-plus mr-2"></i> Registrar Ponto
        <% end %>
      </div>
    </div>

    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
      <div class="flex space-x-2 bg-gray-100 p-1 rounded-lg">
        <%= link_to time_sheets_path, class: "px-4 py-2 rounded-md flex items-center #{current_page?(time_sheets_path) ? 'bg-white shadow-sm text-indigo-700 font-medium' : 'text-gray-700 hover:bg-gray-50'}" do %>
          <i class="fas fa-list mr-2"></i> Lista
        <% end %>

        <%= link_to calendar_time_sheets_path, class: "px-4 py-2 rounded-md flex items-center #{current_page?(calendar_time_sheets_path) ? 'bg-white shadow-sm text-indigo-700 font-medium' : 'text-gray-700 hover:bg-gray-50'}" do %>
          <i class="fas fa-calendar-alt mr-2"></i> Calendário
        <% end %>
      </div>

      <div>
        <%= link_to export_form_time_sheets_path, class: "inline-flex items-center px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition duration-150 ease-in-out shadow-sm" do %>
          <i class="fas fa-file-export mr-2"></i> Exportar
        <% end %>
      </div>
    </div>
  </div>

  <div class="bg-white rounded-lg shadow-lg overflow-hidden mb-6">
    <div class="flex flex-col sm:flex-row justify-between items-center bg-gradient-to-r from-indigo-50 to-indigo-100 p-5 border-b border-indigo-200">
      <div class="flex items-center space-x-2 mb-3 sm:mb-0">
        <%= link_to calendar_time_sheets_path(month: @date.prev_month.month, year: @date.prev_month.year),
                  class: "bg-white hover:bg-gray-50 text-gray-700 p-2 rounded-full shadow-sm flex items-center justify-center transition duration-150 ease-in-out" do %>
          <i class="fas fa-chevron-left"></i>
        <% end %>

        <h2 class="text-2xl font-bold text-indigo-800 px-3">
          <%= l(@date, format: '%B %Y').capitalize %>
        </h2>

        <%= link_to calendar_time_sheets_path(month: @date.next_month.month, year: @date.next_month.year),
                  class: "bg-white hover:bg-gray-50 text-gray-700 p-2 rounded-full shadow-sm flex items-center justify-center transition duration-150 ease-in-out" do %>
          <i class="fas fa-chevron-right"></i>
        <% end %>
      </div>

      <div class="flex items-center">
        <% if @date.month != Date.today.month || @date.year != Date.today.year %>
          <%= link_to calendar_time_sheets_path, class: "text-indigo-600 hover:text-indigo-800 px-3 py-1 rounded-md text-sm flex items-center" do %>
            <i class="fas fa-calendar-day mr-1"></i> Mês Atual
          <% end %>
        <% end %>

        <div class="relative group ml-2">
          <button type="button" class="bg-white hover:bg-gray-50 text-gray-700 px-3 py-1 rounded-md shadow-sm text-sm flex items-center">
            <i class="fas fa-info-circle mr-1 text-indigo-500"></i> Ajuda
          </button>
          <div class="absolute right-0 mt-2 w-64 bg-white rounded-lg shadow-lg p-3 hidden group-hover:block z-10 text-sm text-gray-600">
            <p class="mb-2"><strong>Dicas:</strong></p>
            <ul class="list-disc pl-4 space-y-1">
              <li>Clique em um dia para ver detalhes</li>
              <li>As cores indicam o status do registro</li>
              <li>Use o botão "Registrar Ponto" para marcar sua presença</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-7 bg-gray-50">
      <% ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'].each_with_index do |day, index| %>
        <div class="py-3 text-center font-medium <%= index == 0 || index == 6 ? 'text-red-500' : 'text-gray-700' %> border-b border-gray-200">
          <span class="hidden sm:inline"><%= ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'][index] %></span>
          <span class="sm:hidden"><%= day %></span>
        </div>
      <% end %>
    </div>

    <div class="grid grid-cols-7">
      <% @calendar_days.each do |day| %>
        <%
          time_sheet = @time_sheets_by_date[day]
          is_today = day == Date.today
          current_month = day.month == @date.month
          weekend = day.saturday? || day.sunday?
          holiday = false # Implementar verificação de feriado se aplicável

          # Determine status for styling
          status_class = if !current_month
                           "opacity-40"
                         elsif is_today
                           "bg-indigo-50 shadow-inner"
                         elsif weekend
                           "bg-gray-50"
                         else
                           ""
                         end

          # Status color and label for time sheets
          status_color, status_label = if time_sheet
                                        case time_sheet.approval_status
                                        when 'pendente' then ['bg-yellow-400', 'Pendente']
                                        when 'enviado' then ['bg-blue-400', 'Enviado']
                                        when 'aprovado' then ['bg-green-400', 'Aprovado']
                                        when 'rejeitado' then ['bg-red-400', 'Rejeitado']
                                        else ['bg-gray-400', 'Desconhecido']
                                        end
                                      else
                                        ['', '']
                                      end
        %>

        <div class="border-r border-b last:border-r-0 min-h-[150px] relative group <%= status_class %> <%= is_today ? 'ring-2 ring-indigo-500 z-10' : '' %> hover:bg-indigo-50 transition-colors duration-150">
          <div class="p-3">
            <div class="flex justify-between items-center mb-1">
              <div class="flex items-center">
                <span class="<%= current_month ? 'font-semibold' : 'text-gray-400' %> <%= weekend ? 'text-red-600' : '' %> <%= is_today ? 'text-indigo-700 font-bold' : '' %> text-lg">
                  <%= day.day %>
                </span>

                <% if is_today %>
                  <span class="ml-1 text-xs bg-indigo-100 text-indigo-800 px-1.5 py-0.5 rounded-full">Hoje</span>
                <% end %>
              </div>

              <% if time_sheet && current_month %>
                <div class="flex items-center" title="<%= status_label %>">
                  <div class="<%= status_color %> rounded-full w-4 h-4 shadow-sm"></div>
                  <% if time_sheet.signature %>
                    <i class="fas fa-signature text-green-600 text-xs ml-1" title="Assinado digitalmente"></i>
                  <% end %>
                </div>
              <% end %>
            </div>

            <% if current_month %>
              <% if time_sheet %>
                <%= link_to time_sheet_path(time_sheet), class: "block hover:bg-white rounded-lg p-2 transition duration-150 shadow-sm hover:shadow" do %>
                  <% entries = time_sheet.time_entries.order(:time) %>
                  <% if entries.any? %>
                    <div class="text-xs space-y-2">
                      <% entries.each_slice(2) do |entry_pair| %>
                        <div class="flex justify-between text-gray-600 bg-gray-50 rounded-md p-1.5">
                          <div class="flex items-center">
                            <i class="fas fa-sign-in-alt text-green-500 mr-1"></i>
                            <span class="<%= entry_pair[0]&.entry_type == 'entrada' ? 'text-green-600 font-medium' : '' %>">
                              <%= entry_pair[0]&.time&.strftime("%H:%M") || "--:--" %>
                            </span>
                          </div>
                          <div class="flex items-center">
                            <span class="<%= entry_pair[1]&.entry_type == 'saida' ? 'text-red-600 font-medium' : '' %>">
                              <%= entry_pair[1]&.time&.strftime("%H:%M") || "--:--" %>
                            </span>
                            <i class="fas fa-sign-out-alt text-red-500 ml-1"></i>
                          </div>
                        </div>
                      <% end %>

                      <div class="flex justify-between items-center mt-2 border-t pt-1 border-gray-200">
                        <span class="font-medium text-gray-800 flex items-center">
                          <i class="fas fa-clock text-indigo-400 mr-1"></i>
                          <%= time_sheet.total_hours.to_f rescue 0 %>h
                        </span>
                        <% if time_sheet.approval_status == 'aprovado' %>
                          <span class="text-green-600 flex items-center text-xs bg-green-50 px-1.5 py-0.5 rounded-full">
                            <i class="fas fa-check-circle mr-1"></i> Aprovado
                          </span>
                        <% elsif time_sheet.approval_status == 'rejeitado' %>
                          <span class="text-red-600 flex items-center text-xs bg-red-50 px-1.5 py-0.5 rounded-full">
                            <i class="fas fa-times-circle mr-1"></i> Rejeitado
                          </span>
                        <% end %>
                      </div>
                    </div>
                  <% else %>
                    <div class="text-xs text-gray-500 mt-2 flex items-center justify-center py-2">
                      <i class="fas fa-calendar-times mr-1"></i> Sem registros
                    </div>
                  <% end %>
                <% end %>
              <% else %>
                <div class="flex justify-center items-center h-20">
                  <% if day <= Date.today %>
                    <%= link_to new_time_entry_path(date: day, return_to: "calendar"), class: "text-xs text-indigo-600 hover:text-indigo-800 flex items-center bg-indigo-50 hover:bg-indigo-100 px-2 py-1 rounded-md transition-colors duration-150" do %>
                      <i class="fas fa-plus-circle mr-1"></i> Registrar ponto
                    <% end %>
                  <% end %>
                </div>
              <% end %>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <div class="grid md:grid-cols-2 gap-6">
    <div class="bg-white p-6 rounded-lg shadow-lg border border-gray-100">
      <h3 class="font-bold text-lg mb-4 text-gray-800 flex items-center">
        <i class="fas fa-info-circle text-indigo-500 mr-2"></i> Legenda
      </h3>

      <div class="grid grid-cols-2 gap-4">
        <div class="flex items-center p-2 rounded-md hover:bg-gray-50 transition-colors duration-150">
          <div class="rounded-full w-5 h-5 bg-yellow-400 shadow-sm mr-2"></div>
          <div>
            <span class="text-sm font-medium">Pendente</span>
            <p class="text-xs text-gray-500">Registro não enviado</p>
          </div>
        </div>

        <div class="flex items-center p-2 rounded-md hover:bg-gray-50 transition-colors duration-150">
          <div class="rounded-full w-5 h-5 bg-blue-400 shadow-sm mr-2"></div>
          <div>
            <span class="text-sm font-medium">Enviado</span>
            <p class="text-xs text-gray-500">Aguardando aprovação</p>
          </div>
        </div>

        <div class="flex items-center p-2 rounded-md hover:bg-gray-50 transition-colors duration-150">
          <div class="rounded-full w-5 h-5 bg-green-400 shadow-sm mr-2"></div>
          <div>
            <span class="text-sm font-medium">Aprovado</span>
            <p class="text-xs text-gray-500">Registro confirmado</p>
          </div>
        </div>

        <div class="flex items-center p-2 rounded-md hover:bg-gray-50 transition-colors duration-150">
          <div class="rounded-full w-5 h-5 bg-red-400 shadow-sm mr-2"></div>
          <div>
            <span class="text-sm font-medium">Rejeitado</span>
            <p class="text-xs text-gray-500">Necessita correção</p>
          </div>
        </div>
      </div>

      <div class="mt-4 pt-4 border-t border-gray-100">
        <h4 class="font-medium text-sm mb-2 text-gray-700">Ícones</h4>
        <div class="grid grid-cols-2 gap-3">
          <div class="flex items-center">
            <i class="fas fa-signature text-green-600 mr-2"></i>
            <span class="text-xs text-gray-600">Assinado digitalmente</span>
          </div>
          <div class="flex items-center">
            <i class="fas fa-sign-in-alt text-green-500 mr-2"></i>
            <span class="text-xs text-gray-600">Entrada</span>
          </div>
          <div class="flex items-center">
            <i class="fas fa-sign-out-alt text-red-500 mr-2"></i>
            <span class="text-xs text-gray-600">Saída</span>
          </div>
          <div class="flex items-center">
            <i class="fas fa-clock text-indigo-400 mr-2"></i>
            <span class="text-xs text-gray-600">Total de horas</span>
          </div>
        </div>
      </div>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-lg border border-gray-100">
      <h3 class="font-bold text-lg mb-4 text-gray-800 flex items-center">
        <i class="fas fa-chart-pie text-indigo-500 mr-2"></i> Resumo do Mês
      </h3>

      <% 
        # Calculate statistics
        total_days = @time_sheets.count
        total_hours = 0
        @time_sheets.each { |ts| total_hours += ts.total_hours.to_f rescue 0 }
        pending_count = @time_sheets.select { |ts| ts&.approval_status == 'pendente' }.count
        approved_count = @time_sheets.select { |ts| ts&.approval_status == 'aprovado' }.count
        sent_count = @time_sheets.select { |ts| ts&.approval_status == 'enviado' }.count
        rejected_count = @time_sheets.select { |ts| ts&.approval_status == 'rejeitado' }.count

        # Calculate expected work days (excluding weekends)
        business_days = ((@date.beginning_of_month..@date.end_of_month).to_a - (@date.beginning_of_month..@date.end_of_month).to_a.select {|d| d.saturday? || d.sunday?}).count

        # Calculate completion percentage
        completion_percentage = business_days > 0 ? (total_days.to_f / business_days * 100).round : 0
        completion_percentage = [completion_percentage, 100].min
      %>

      <div class="mb-4">
        <div class="flex justify-between items-center mb-1">
          <span class="text-sm font-medium text-gray-700">Progresso do mês</span>
          <span class="text-sm font-medium text-indigo-600"><%= completion_percentage %>%</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2.5">
          <div class="bg-indigo-600 h-2.5 rounded-full" style="width: <%= completion_percentage %>%"></div>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4 mb-4">
        <div class="bg-indigo-50 p-3 rounded-lg">
          <div class="text-xs text-indigo-600 mb-1">Dias Trabalhados</div>
          <div class="text-xl font-bold text-indigo-800"><%= total_days %> <span class="text-xs font-normal text-indigo-600">/ <%= business_days %> dias úteis</span></div>
        </div>

        <div class="bg-indigo-50 p-3 rounded-lg">
          <div class="text-xs text-indigo-600 mb-1">Total de Horas</div>
          <div class="text-xl font-bold text-indigo-800"><%= total_hours.round(1) %> <span class="text-xs font-normal text-indigo-600">horas</span></div>
        </div>
      </div>

      <div class="space-y-2">
        <div class="flex justify-between items-center p-2 hover:bg-gray-50 rounded-md">
          <span class="text-gray-700 flex items-center">
            <div class="w-3 h-3 rounded-full bg-yellow-400 mr-2"></div>
            Pendentes:
          </span>
          <span class="font-medium"><%= pending_count %></span>
        </div>

        <div class="flex justify-between items-center p-2 hover:bg-gray-50 rounded-md">
          <span class="text-gray-700 flex items-center">
            <div class="w-3 h-3 rounded-full bg-blue-400 mr-2"></div>
            Enviados:
          </span>
          <span class="font-medium"><%= sent_count %></span>
        </div>

        <div class="flex justify-between items-center p-2 hover:bg-gray-50 rounded-md">
          <span class="text-gray-700 flex items-center">
            <div class="w-3 h-3 rounded-full bg-green-400 mr-2"></div>
            Aprovados:
          </span>
          <span class="font-medium"><%= approved_count %></span>
        </div>

        <div class="flex justify-between items-center p-2 hover:bg-gray-50 rounded-md">
          <span class="text-gray-700 flex items-center">
            <div class="w-3 h-3 rounded-full bg-red-400 mr-2"></div>
            Rejeitados:
          </span>
          <span class="font-medium"><%= rejected_count %></span>
        </div>
      </div>
    </div>
  </div>
</div>
