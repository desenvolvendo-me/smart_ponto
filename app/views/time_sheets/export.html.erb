<div class="flex items-center mb-6">
  <%= link_to time_sheets_path, class: "text-2xl text-gray-600 hover:text-indigo-600 transition-colors duration-200" do %>
    <i class="fas fa-arrow-left"></i>
  <% end %>
  <h1 class="text-2xl font-bold ml-4 text-gray-800">Exportar Registros</h1>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
  <!-- Painel de Configurações -->
  <div class="lg:col-span-2">
    <div class="bg-white p-6 rounded-lg shadow-md border border-gray-100">
      <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
        <i class="fas fa-cog text-indigo-500 mr-2"></i>
        Configurações de Exportação
      </h2>

      <%= form_with(url: export_time_sheets_path, method: :get, class: "space-y-6", id: "export-form") do |form| %>
        <!-- Período -->
        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
          <h3 class="text-md font-medium text-gray-700 mb-3">Período</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <%= form.label :start_date, "Data Inicial", class: "block text-gray-600 font-medium mb-1 text-sm" %>
              <%= form.date_field :start_date, value: Date.today.beginning_of_month, class: "w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-300 focus:border-indigo-500 transition-all duration-200" %>
            </div>

            <div>
              <%= form.label :end_date, "Data Final", class: "block text-gray-600 font-medium mb-1 text-sm" %>
              <%= form.date_field :end_date, value: Date.today, class: "w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-300 focus:border-indigo-500 transition-all duration-200" %>
            </div>
          </div>
        </div>

        <!-- Filtros -->
        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
          <h3 class="text-md font-medium text-gray-700 mb-3">Filtros</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <%= form.label :status, "Status de Aprovação", class: "block text-gray-600 font-medium mb-1 text-sm" %>
              <%= form.select :status, 
                  [["Todos", ""], ["Pendente", "pendente"], ["Enviado", "enviado"], ["Aprovado", "aprovado"], ["Rejeitado", "rejeitado"]], 
                  {}, 
                  class: "w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-300 focus:border-indigo-500 transition-all duration-200" %>
            </div>

            <div>
              <%= form.label :complete, "Completude", class: "block text-gray-600 font-medium mb-1 text-sm" %>
              <%= form.select :complete, 
                  [["Todos", ""], ["Completos", "completo"], ["Incompletos", "incompleto"]], 
                  {}, 
                  class: "w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-300 focus:border-indigo-500 transition-all duration-200" %>
            </div>
          </div>
        </div>

        <!-- Formato -->
        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
          <h3 class="text-md font-medium text-gray-700 mb-3">Formato</h3>
          <div class="flex space-x-4">
            <div class="flex items-center">
              <%= form.radio_button :format, "csv", checked: true, class: "h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300" %>
              <%= form.label :format_csv, "CSV", class: "ml-2 block text-sm text-gray-700" %>
            </div>
            <div class="flex items-center">
              <%= form.radio_button :format, "excel", class: "h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300" %>
              <%= form.label :format_excel, "Excel", class: "ml-2 block text-sm text-gray-700" %>
            </div>
          </div>
        </div>

        <!-- Botões -->
        <div class="flex justify-end space-x-3">
          <%= link_to "Cancelar", time_sheets_path, class: "px-4 py-2 border border-gray-300 rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-200" %>

          <%= form.button type: "submit", class: "px-6 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-all duration-200 flex items-center" do %>
            <i class="fas fa-file-export mr-2"></i>
            Exportar Registros
          <% end %>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Painel de Ajuda -->
  <div class="lg:col-span-1">
    <div class="bg-white p-6 rounded-lg shadow-md border border-gray-100 h-full">
      <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
        <i class="fas fa-info-circle text-indigo-500 mr-2"></i>
        Informações
      </h2>

      <div class="space-y-4 text-gray-600">
        <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
          <h3 class="text-md font-medium text-blue-800 mb-2 flex items-center">
            <i class="fas fa-lightbulb text-blue-500 mr-2"></i>
            Dicas
          </h3>
          <ul class="list-disc list-inside space-y-2 text-sm">
            <li>Selecione um período específico para exportar apenas os registros desejados</li>
            <li>Use os filtros para refinar os resultados da exportação</li>
            <li>Escolha o formato que melhor atende às suas necessidades</li>
          </ul>
        </div>

        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
          <h3 class="text-md font-medium text-gray-700 mb-2">O que será exportado?</h3>
          <p class="text-sm">
            Serão exportados os registros de ponto do período selecionado, incluindo:
          </p>
          <ul class="list-disc list-inside mt-2 text-sm">
            <li>Data do registro</li>
            <li>Horários de entrada e saída</li>
            <li>Total de horas trabalhadas</li>
            <li>Status de aprovação</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Preview dos dados (opcional, pode ser adicionado posteriormente) -->
<div class="mt-6 bg-white p-6 rounded-lg shadow-md border border-gray-100">
  <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
    <i class="fas fa-table text-indigo-500 mr-2"></i>
    Prévia dos Dados
  </h2>

  <p class="text-gray-600 text-sm mb-4">
    Abaixo está uma prévia dos primeiros registros que serão exportados com as configurações atuais.
  </p>

  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Entrada 1</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Saída 1</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Entrada 2</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Saída 2</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        <% current_user.time_sheets.order(date: :desc).limit(3).each do |sheet| %>
          <tr>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900"><%= sheet.date.strftime("%d/%m/%Y") %></td>
            <% 
              entries = sheet.time_entries.order(:time)
              times = entries.map { |e| e.time.strftime("%H:%M") }
              while times.length < 4
                times << "-"
              end
            %>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"><%= times[0] %></td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"><%= times[1] %></td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"><%= times[2] %></td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"><%= times[3] %></td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"><%= sheet.total_hours.to_f %>h</td>
            <td class="px-6 py-4 whitespace-nowrap">
              <% case sheet.approval_status %>
              <% when 'aprovado' %>
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                  Aprovado
                </span>
              <% when 'enviado' %>
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                  Enviado
                </span>
              <% when 'rejeitado' %>
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">
                  Rejeitado
                </span>
              <% else %>
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">
                  Pendente
                </span>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>

<script>
  document.addEventListener('turbo:load', function() {
    // Obter referências aos elementos do formulário
    const form = document.getElementById('export-form');
    const csvRadio = document.querySelector('input[name="format"][value="csv"]');
    const excelRadio = document.querySelector('input[name="format"][value="excel"]');

    // Adicionar event listener para o envio do formulário
    if (form) {
      form.addEventListener('submit', function(event) {
        // Prevenir o envio padrão do formulário
        event.preventDefault();

        // Determinar o formato selecionado
        let format = 'csv'; // Formato padrão
        if (excelRadio && excelRadio.checked) {
          format = 'xlsx';
        }

        // Construir a URL com o formato correto
        const formData = new FormData(form);
        const params = new URLSearchParams();

        // Adicionar todos os parâmetros do formulário
        for (const [key, value] of formData.entries()) {
          if (key !== 'format') { // Ignorar o campo format, pois será adicionado à extensão da URL
            params.append(key, value);
          }
        }

        // Construir a URL final
        let url = form.action;
        if (params.toString()) {
          url += '?' + params.toString();
        }

        // Adicionar a extensão do formato
        if (!url.includes('.')) {
          url += '.' + format;
        }

        // Redirecionar para a URL construída
        window.location.href = url;
      });
    }
  });
</script>
