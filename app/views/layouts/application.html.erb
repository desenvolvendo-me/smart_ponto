<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Ponto</title>
  <%= csrf_meta_tags %>
  <%= csp_meta_tag %>
  <%= stylesheet_link_tag "tailwind", "data-turbo-track": "reload" %>
  <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
  <%= javascript_importmap_tags %>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
</head>

<body class="bg-gray-100">
<div class="flex h-screen overflow-hidden">
  <!-- Sidebar para desktop -->
  <div id="desktop-sidebar" class="hidden md:flex md:flex-shrink-0 transition-all duration-300 ease-in-out">
    <div class="flex flex-col w-64 bg-gradient-to-b from-gray-800 to-gray-900 shadow-xl">
      <!-- Logo e título -->
      <div class="flex items-center h-16 px-6 bg-gray-900">
        <i class="fas fa-clock text-indigo-400 text-2xl mr-3"></i>
        <span class="text-xl text-white font-bold tracking-wide">Smart Ponto</span>
      </div>
      <!-- Menu de navegação -->
      <div class="flex flex-col flex-grow px-4 py-6">
        <nav class="flex-1 space-y-1">
          <% if user_signed_in? %>
            <% dashboard_active = current_page?(dashboard_index_path) %>
            <%= link_to dashboard_index_path, 
                class: "group flex items-center px-3 py-2.5 text-sm font-medium rounded-lg transition-all duration-200 ease-in-out
                       #{dashboard_active ? 'bg-indigo-700 text-white shadow-md' : 'text-gray-300 hover:bg-gray-700 hover:text-white'}" do %>
              <div class="flex items-center justify-center w-8 h-8 <%= dashboard_active ? 'text-indigo-200' : 'text-gray-400 group-hover:text-gray-200' %> transition-colors duration-200">
                <i class="fas fa-tachometer-alt"></i>
              </div>
              <span class="ml-3">Dashboard</span>
              <% if dashboard_active %>
                <span class="ml-auto w-1.5 h-1.5 rounded-full bg-indigo-300"></span>
              <% end %>
            <% end %>

            <% time_sheets_active = current_page?(time_sheets_path) || request.path.include?('/meu-ponto/') && !request.path.include?('/calendar') && !request.path.include?('/export') %>
            <%= link_to time_sheets_path, 
                class: "group flex items-center px-3 py-2.5 text-sm font-medium rounded-lg transition-all duration-200 ease-in-out
                       #{time_sheets_active ? 'bg-indigo-700 text-white shadow-md' : 'text-gray-300 hover:bg-gray-700 hover:text-white'}" do %>
              <div class="flex items-center justify-center w-8 h-8 <%= time_sheets_active ? 'text-indigo-200' : 'text-gray-400 group-hover:text-gray-200' %> transition-colors duration-200">
                <i class="fas fa-clock"></i>
              </div>
              <span class="ml-3">Meu Ponto</span>
              <% if time_sheets_active %>
                <span class="ml-auto w-1.5 h-1.5 rounded-full bg-indigo-300"></span>
              <% end %>
            <% end %>

            <% calendar_active = current_page?(calendar_time_sheets_path) || request.path.include?('/calendar') %>
            <%= link_to calendar_time_sheets_path, 
                class: "group flex items-center px-3 py-2.5 text-sm font-medium rounded-lg transition-all duration-200 ease-in-out
                       #{calendar_active ? 'bg-indigo-700 text-white shadow-md' : 'text-gray-300 hover:bg-gray-700 hover:text-white'}" do %>
              <div class="flex items-center justify-center w-8 h-8 <%= calendar_active ? 'text-indigo-200' : 'text-gray-400 group-hover:text-gray-200' %> transition-colors duration-200">
                <i class="fas fa-calendar-alt"></i>
              </div>
              <span class="ml-3">Calendário</span>
              <% if calendar_active %>
                <span class="ml-auto w-1.5 h-1.5 rounded-full bg-indigo-300"></span>
              <% end %>
            <% end %>

            <% export_active = current_page?(export_form_time_sheets_path) || request.path.include?('/export') %>
            <%= link_to export_form_time_sheets_path, 
                class: "group flex items-center px-3 py-2.5 text-sm font-medium rounded-lg transition-all duration-200 ease-in-out
                       #{export_active ? 'bg-indigo-700 text-white shadow-md' : 'text-gray-300 hover:bg-gray-700 hover:text-white'}" do %>
              <div class="flex items-center justify-center w-8 h-8 <%= export_active ? 'text-indigo-200' : 'text-gray-400 group-hover:text-gray-200' %> transition-colors duration-200">
                <i class="fas fa-file-export"></i>
              </div>
              <span class="ml-3">Exportar Registros</span>
              <% if export_active %>
                <span class="ml-auto w-1.5 h-1.5 rounded-full bg-indigo-300"></span>
              <% end %>
            <% end %>

            <% if current_user.role == 'gestor' %>
              <div class="pt-4 mt-4 border-t border-gray-700">
                <h3 class="px-3 text-xs font-semibold text-indigo-300 uppercase tracking-wider mb-2">Administração</h3>
              </div>

              <%= link_to "#", 
                  class: "group flex items-center px-3 py-2.5 text-sm font-medium rounded-lg transition-all duration-200 ease-in-out
                         text-gray-300 hover:bg-gray-700 hover:text-white" do %>
                <div class="flex items-center justify-center w-8 h-8 text-gray-400 group-hover:text-gray-200 transition-colors duration-200">
                  <i class="fas fa-users"></i>
                </div>
                <span class="ml-3">Usuários</span>
              <% end %>

              <% approvals_active = current_page?(approvals_path) || request.path.include?('/approvals') %>
              <%= link_to approvals_path, 
                  class: "group flex items-center px-3 py-2.5 text-sm font-medium rounded-lg transition-all duration-200 ease-in-out
                         #{approvals_active ? 'bg-indigo-700 text-white shadow-md' : 'text-gray-300 hover:bg-gray-700 hover:text-white'}" do %>
                <div class="flex items-center justify-center w-8 h-8 <%= approvals_active ? 'text-indigo-200' : 'text-gray-400 group-hover:text-gray-200' %> transition-colors duration-200">
                  <i class="fas fa-clipboard-check"></i>
                </div>
                <span class="ml-3">Aprovações</span>
                <% if approvals_active %>
                  <span class="ml-auto w-1.5 h-1.5 rounded-full bg-indigo-300"></span>
                <% end %>
              <% end %>
            <% end %>
          <% end %>
        </nav>

        <% if user_signed_in? %>
          <div class="pt-6 mt-6 border-t border-gray-700">
            <div class="bg-gray-800 rounded-lg p-4 shadow-inner">
              <div class="flex items-center mb-3">
                <div class="flex-shrink-0 bg-indigo-600 rounded-full p-2">
                  <i class="fas fa-user text-xl text-white"></i>
                </div>
                <div class="ml-3">
                  <p class="text-sm font-medium text-white"><%= current_user.name %></p>
                  <p class="text-xs text-gray-400 truncate max-w-[140px]"><%= current_user.email %></p>
                </div>
              </div>

              <div class="space-y-2">
                <%= link_to edit_user_preference_path, class: "group flex items-center px-3 py-2 text-sm font-medium rounded-md bg-gray-700 text-gray-300 hover:bg-indigo-600 hover:text-white transition-all duration-200" do %>
                  <div class="flex items-center justify-center w-6 h-6 text-gray-400 group-hover:text-white transition-colors duration-200">
                    <i class="fas fa-cog"></i>
                  </div>
                  <span class="ml-2">Configurações</span>
                <% end %>

                <%= button_to destroy_user_session_path, method: :delete, class: "w-full flex items-center justify-center px-3 py-2 text-sm font-medium rounded-md bg-gray-700 text-gray-300 hover:bg-red-600 hover:text-white transition-all duration-200 mt-2" do %>
                  <div class="flex items-center justify-center w-6 h-6">
                    <i class="fas fa-sign-out-alt"></i>
                  </div>
                  <span class="ml-2">Sair</span>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Conteúdo principal -->
  <div class="flex flex-col flex-1 w-0 overflow-hidden">
    <!-- Barra superior móvel -->
    <div class="md:hidden bg-gradient-to-r from-gray-800 to-gray-900 text-white p-4 flex items-center justify-between shadow-md">
      <div class="flex items-center">
        <i class="fas fa-clock text-indigo-400 text-xl mr-3"></i>
        <span class="text-xl font-bold tracking-wide">Smart Ponto</span>
      </div>
      <button id="mobile-menu-button" class="text-white focus:outline-none bg-gray-700 hover:bg-gray-600 p-2 rounded-lg transition-colors duration-200">
        <i class="fas fa-bars"></i>
      </button>
    </div>

    <!-- Barra superior desktop com botão de toggle do menu -->
    <div class="hidden md:flex items-center justify-between bg-white p-4 shadow-sm relative z-10">
      <button id="desktop-sidebar-toggle" class="text-gray-600 focus:outline-none hover:text-indigo-600 p-3 rounded-lg transition-colors duration-200 cursor-pointer relative z-20">
        <i class="fas fa-bars"></i>
      </button>
      <div class="flex-grow"></div>
    </div>

    <!-- Conteúdo principal -->
    <main class="flex-1 relative overflow-y-auto focus:outline-none p-4">
      <%= render 'shared/flash' %>
      <%= yield %>
    </main>
  </div>

  <!-- Menu lateral móvel (oculto por padrão) -->
  <div id="mobile-menu" class="fixed inset-0 flex z-40 md:hidden hidden">
    <div class="fixed inset-0 bg-gray-600 bg-opacity-0 transition-opacity duration-300 ease-in-out" aria-hidden="true" id="mobile-backdrop"></div>
    <div class="relative flex-1 flex flex-col max-w-xs w-full bg-gradient-to-b from-gray-800 to-gray-900 shadow-xl transform -translate-x-full transition-transform duration-300 ease-in-out">
      <div class="absolute top-0 right-0 -mr-12 pt-2">
        <button id="close-mobile-menu" class="ml-1 flex items-center justify-center h-10 w-10 rounded-full focus:outline-none bg-gray-800 hover:bg-gray-700 transition-colors duration-200">
          <span class="sr-only">Fechar menu</span>
          <i class="fas fa-times text-white"></i>
        </button>
      </div>

      <!-- Conteúdo do menu móvel -->
      <div class="flex items-center h-16 px-6 bg-gray-900">
        <i class="fas fa-clock text-indigo-400 text-2xl mr-3"></i>
        <span class="text-xl text-white font-bold tracking-wide">Smart Ponto</span>
      </div>
      <div class="flex-1 h-0 overflow-y-auto">
        <nav class="px-4 py-6 space-y-1">
          <% if user_signed_in? %>
            <% dashboard_active = current_page?(dashboard_index_path) %>
            <%= link_to dashboard_index_path, 
                class: "group flex items-center px-3 py-2.5 text-sm font-medium rounded-lg transition-all duration-200 ease-in-out
                       #{dashboard_active ? 'bg-indigo-700 text-white shadow-md' : 'text-gray-300 hover:bg-gray-700 hover:text-white'}" do %>
              <div class="flex items-center justify-center w-8 h-8 <%= dashboard_active ? 'text-indigo-200' : 'text-gray-400 group-hover:text-gray-200' %> transition-colors duration-200">
                <i class="fas fa-tachometer-alt"></i>
              </div>
              <span class="ml-3">Dashboard</span>
              <% if dashboard_active %>
                <span class="ml-auto w-1.5 h-1.5 rounded-full bg-indigo-300"></span>
              <% end %>
            <% end %>

            <% time_sheets_active = current_page?(time_sheets_path) || request.path.include?('/meu-ponto/') && !request.path.include?('/calendar') && !request.path.include?('/export') %>
            <%= link_to time_sheets_path, 
                class: "group flex items-center px-3 py-2.5 text-sm font-medium rounded-lg transition-all duration-200 ease-in-out
                       #{time_sheets_active ? 'bg-indigo-700 text-white shadow-md' : 'text-gray-300 hover:bg-gray-700 hover:text-white'}" do %>
              <div class="flex items-center justify-center w-8 h-8 <%= time_sheets_active ? 'text-indigo-200' : 'text-gray-400 group-hover:text-gray-200' %> transition-colors duration-200">
                <i class="fas fa-clock"></i>
              </div>
              <span class="ml-3">Meu Ponto</span>
              <% if time_sheets_active %>
                <span class="ml-auto w-1.5 h-1.5 rounded-full bg-indigo-300"></span>
              <% end %>
            <% end %>

            <% calendar_active = current_page?(calendar_time_sheets_path) || request.path.include?('/calendar') %>
            <%= link_to calendar_time_sheets_path, 
                class: "group flex items-center px-3 py-2.5 text-sm font-medium rounded-lg transition-all duration-200 ease-in-out
                       #{calendar_active ? 'bg-indigo-700 text-white shadow-md' : 'text-gray-300 hover:bg-gray-700 hover:text-white'}" do %>
              <div class="flex items-center justify-center w-8 h-8 <%= calendar_active ? 'text-indigo-200' : 'text-gray-400 group-hover:text-gray-200' %> transition-colors duration-200">
                <i class="fas fa-calendar-alt"></i>
              </div>
              <span class="ml-3">Calendário</span>
              <% if calendar_active %>
                <span class="ml-auto w-1.5 h-1.5 rounded-full bg-indigo-300"></span>
              <% end %>
            <% end %>

            <% export_active = current_page?(export_form_time_sheets_path) || request.path.include?('/export') %>
            <%= link_to export_form_time_sheets_path, 
                class: "group flex items-center px-3 py-2.5 text-sm font-medium rounded-lg transition-all duration-200 ease-in-out
                       #{export_active ? 'bg-indigo-700 text-white shadow-md' : 'text-gray-300 hover:bg-gray-700 hover:text-white'}" do %>
              <div class="flex items-center justify-center w-8 h-8 <%= export_active ? 'text-indigo-200' : 'text-gray-400 group-hover:text-gray-200' %> transition-colors duration-200">
                <i class="fas fa-file-export"></i>
              </div>
              <span class="ml-3">Exportar Registros</span>
              <% if export_active %>
                <span class="ml-auto w-1.5 h-1.5 rounded-full bg-indigo-300"></span>
              <% end %>
            <% end %>

            <% if current_user.role == 'gestor' %>
              <div class="pt-4 mt-4 border-t border-gray-700">
                <h3 class="px-3 text-xs font-semibold text-indigo-300 uppercase tracking-wider mb-2">Administração</h3>
              </div>

              <%= link_to "#", 
                  class: "group flex items-center px-3 py-2.5 text-sm font-medium rounded-lg transition-all duration-200 ease-in-out
                         text-gray-300 hover:bg-gray-700 hover:text-white" do %>
                <div class="flex items-center justify-center w-8 h-8 text-gray-400 group-hover:text-gray-200 transition-colors duration-200">
                  <i class="fas fa-users"></i>
                </div>
                <span class="ml-3">Usuários</span>
              <% end %>

              <% approvals_active = current_page?(approvals_path) || request.path.include?('/approvals') %>
              <%= link_to approvals_path, 
                  class: "group flex items-center px-3 py-2.5 text-sm font-medium rounded-lg transition-all duration-200 ease-in-out
                         #{approvals_active ? 'bg-indigo-700 text-white shadow-md' : 'text-gray-300 hover:bg-gray-700 hover:text-white'}" do %>
                <div class="flex items-center justify-center w-8 h-8 <%= approvals_active ? 'text-indigo-200' : 'text-gray-400 group-hover:text-gray-200' %> transition-colors duration-200">
                  <i class="fas fa-clipboard-check"></i>
                </div>
                <span class="ml-3">Aprovações</span>
                <% if approvals_active %>
                  <span class="ml-auto w-1.5 h-1.5 rounded-full bg-indigo-300"></span>
                <% end %>
              <% end %>
            <% end %>
          <% end %>
        </nav>

        <% if user_signed_in? %>
          <div class="px-4 pt-6 pb-6">
            <div class="bg-gray-800 rounded-lg p-4 shadow-inner">
              <div class="flex items-center mb-3">
                <div class="flex-shrink-0 bg-indigo-600 rounded-full p-2">
                  <i class="fas fa-user text-xl text-white"></i>
                </div>
                <div class="ml-3">
                  <p class="text-sm font-medium text-white"><%= current_user.name %></p>
                  <p class="text-xs text-gray-400 truncate max-w-[140px]"><%= current_user.email %></p>
                </div>
              </div>

              <div class="space-y-2">
                <%= link_to edit_user_preference_path, class: "group flex items-center px-3 py-2 text-sm font-medium rounded-md bg-gray-700 text-gray-300 hover:bg-indigo-600 hover:text-white transition-all duration-200" do %>
                  <div class="flex items-center justify-center w-6 h-6 text-gray-400 group-hover:text-white transition-colors duration-200">
                    <i class="fas fa-cog"></i>
                  </div>
                  <span class="ml-2">Configurações</span>
                <% end %>

                <%= button_to destroy_user_session_path, method: :delete, class: "w-full flex items-center justify-center px-3 py-2 text-sm font-medium rounded-md bg-gray-700 text-gray-300 hover:bg-red-600 hover:text-white transition-all duration-200 mt-2" do %>
                  <div class="flex items-center justify-center w-6 h-6">
                    <i class="fas fa-sign-out-alt"></i>
                  </div>
                  <span class="ml-2">Sair</span>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript para controle dos menus -->
<script>
    document.addEventListener('turbo:load', function() {
        // Mobile menu elements
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        const closeMobileMenuBtn = document.getElementById('close-mobile-menu');
        const mobileBackdrop = document.getElementById('mobile-backdrop');
        const menuPanel = document.querySelector('#mobile-menu > div:nth-child(2)');

        // Desktop sidebar elements
        const desktopSidebar = document.getElementById('desktop-sidebar');
        const desktopSidebarToggle = document.getElementById('desktop-sidebar-toggle');
        const mainContent = document.querySelector('.flex-1.w-0');

        // Check if sidebar state is stored in localStorage
        let sidebarCollapsed = localStorage.getItem('sidebarCollapsed');
        console.log('Initial localStorage sidebarCollapsed value:', sidebarCollapsed);

        // If sidebarCollapsed is null (first visit) or not a valid value, set it to false (expanded)
        if (sidebarCollapsed === null || (sidebarCollapsed !== 'true' && sidebarCollapsed !== 'false')) {
            console.log('First visit or invalid value, setting sidebarCollapsed to false');
            localStorage.setItem('sidebarCollapsed', 'false');
            sidebarCollapsed = 'false';
        }

        // Convert to boolean
        sidebarCollapsed = sidebarCollapsed === 'true';
        console.log('sidebarCollapsed as boolean:', sidebarCollapsed);
        console.log('Initial sidebar classes:', desktopSidebar.className);

        // Initialize desktop sidebar state
        if (sidebarCollapsed) {
            console.log('Initializing sidebar as collapsed');
            desktopSidebar.classList.add('md:w-0');
            desktopSidebar.classList.add('md:opacity-0');
            desktopSidebar.classList.add('pointer-events-none');
            mainContent.classList.add('md:ml-0');
            desktopSidebarToggle.innerHTML = '<i class="fas fa-expand"></i>';
            console.log('Sidebar initialized as collapsed, classes:', desktopSidebar.className);
        } else {
            console.log('Initializing sidebar as expanded');
            // Ensure sidebar is expanded by default
            desktopSidebar.classList.remove('md:w-0');
            desktopSidebar.classList.remove('md:opacity-0');
            mainContent.classList.remove('md:ml-0');
            desktopSidebarToggle.innerHTML = '<i class="fas fa-bars"></i>';
            console.log('Sidebar initialized as expanded, classes:', desktopSidebar.className);
        }

        // Mobile menu functions
        function openMobileMenu() {
            // Mostrar o menu
            mobileMenu.classList.remove('hidden');

            // Adicionar classe para animar a entrada
            setTimeout(() => {
                if (mobileBackdrop) {
                    mobileBackdrop.classList.add('opacity-75');
                    mobileBackdrop.classList.remove('opacity-0');
                }

                if (menuPanel) {
                    menuPanel.classList.add('translate-x-0');
                    menuPanel.classList.remove('-translate-x-full');
                }
            }, 10);
        }

        function closeMobileMenu() {
            // Animar a saída
            if (mobileBackdrop) {
                mobileBackdrop.classList.remove('opacity-75');
                mobileBackdrop.classList.add('opacity-0');
            }

            if (menuPanel) {
                menuPanel.classList.remove('translate-x-0');
                menuPanel.classList.add('-translate-x-full');
            }

            // Esconder o menu após a animação
            setTimeout(() => {
                mobileMenu.classList.add('hidden');
            }, 300);
        }

        // Desktop sidebar toggle function
        function toggleDesktopSidebar() {
            console.log('toggleDesktopSidebar called');
            console.log('Current sidebar classes:', desktopSidebar.className);
            console.log('Has md:w-0 class:', desktopSidebar.classList.contains('md:w-0'));

            try {
                // Force toggle based on current visual state rather than localStorage
                const isCurrentlyCollapsed = desktopSidebar.classList.contains('md:w-0');
                console.log('Is currently collapsed based on classes:', isCurrentlyCollapsed);

                if (isCurrentlyCollapsed) {
                    console.log('Expanding sidebar');
                    // Expand sidebar
                    desktopSidebar.classList.remove('md:w-0');
                    desktopSidebar.classList.remove('md:opacity-0');
                    desktopSidebar.classList.remove('pointer-events-none');
                    mainContent.classList.remove('md:ml-0');
                    desktopSidebarToggle.innerHTML = '<i class="fas fa-bars"></i>';
                    localStorage.setItem('sidebarCollapsed', 'false');
                    console.log('Sidebar expanded, new classes:', desktopSidebar.className);
                } else {
                    console.log('Collapsing sidebar');
                    // Collapse sidebar
                    desktopSidebar.classList.add('md:w-0');
                    desktopSidebar.classList.add('md:opacity-0');
                    desktopSidebar.classList.add('pointer-events-none');
                    mainContent.classList.add('md:ml-0');
                    desktopSidebarToggle.innerHTML = '<i class="fas fa-expand"></i>';
                    localStorage.setItem('sidebarCollapsed', 'true');
                    console.log('Sidebar collapsed, new classes:', desktopSidebar.className);
                }
            } catch (error) {
                console.error('Error in toggleDesktopSidebar:', error);
            }
        }

        // Add event listeners
        if (mobileMenuButton) {
            mobileMenuButton.addEventListener('click', openMobileMenu);
        }

        if (closeMobileMenuBtn) {
            closeMobileMenuBtn.addEventListener('click', closeMobileMenu);
        }

        if (mobileBackdrop) {
            mobileBackdrop.addEventListener('click', closeMobileMenu);
            mobileBackdrop.classList.add('opacity-0');
        }

        if (menuPanel) {
            menuPanel.classList.add('-translate-x-full');
        }

        // Add debugging to check if the toggle button is found
        console.log('Desktop sidebar toggle button:', desktopSidebarToggle);

        if (desktopSidebarToggle) {
            console.log('Adding click event listener to desktop sidebar toggle button');

            // Use a direct onclick handler
            desktopSidebarToggle.onclick = function(e) {
                console.log('Toggle button clicked directly');
                e.preventDefault();
                toggleDesktopSidebar();
                return false; // Prevent default action
            };
        } else {
            console.error('Desktop sidebar toggle button not found!');
        }
    });
</script>
</body>
</html>
